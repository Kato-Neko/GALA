{% extends 'base.html' %}
<!-- admin_location.html -->
{% block content %}
<div class="container mt-4">
    <h2>Manage Locations</h2>
    
    <!-- Add Location Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="locationForm" method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" name="name" class="form-control" placeholder="Location Name" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="description" class="form-control" placeholder="Description" required>
                    </div>
                    <div class="col-md-2">
                        <input type="text" name="longitude" class="form-control" placeholder="Longitude" required>
                    </div>
                    <div class="col-md-2">
                        <input type="text" name="latitude" class="form-control" placeholder="Latitude" required>
                    </div>
                    <div class="col-md-2">
                        <input type="text" name="weather" class="form-control" placeholder="Weather" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Add Location</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Locations Table -->
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Longitude</th>
                    <th>Latitude</th>
                    <th>Weather</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="locationTableBody">
                {% for location in locations %}
                <tr data-id="{{ location.id }}">
                    <td>{{ location.name }}</td>
                    <td>{{ location.description }}</td>
                    <td>{{ location.longitude }}</td>
                    <td>{{ location.latitude }}</td>
                    <td>{{ location.weather }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn">Edit</button>
                        <button class="btn btn-sm btn-danger delete-btn">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Location</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" name="location_id">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" name="description" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="text" name="longitude" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="text" name="latitude" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Weather</label>
                        <input type="text" name="weather" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEdit">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Add Location
    $('#locationForm').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            url: '{% url "add_location" %}',
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.status === 'success') {
                    const location = response.location;
                    const newRow = `
                        <tr data-id="${location.id}">
                            <td>${location.name}</td>
                            <td>${location.description}</td>
                            <td>${location.longitude}</td>
                            <td>${location.latitude}</td>
                            <td>${location.weather}</td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-btn">Edit</button>
                                <button class="btn btn-sm btn-danger delete-btn">Delete</button>
                            </td>
                        </tr>
                    `;
                    $('#locationTableBody').append(newRow);
                    $('#locationForm')[0].reset();
                }
            }
        });
    });

    // Edit Location
    $(document).on('click', '.edit-btn', function() {
        const row = $(this).closest('tr');
        const id = row.data('id');
        const name = row.find('td:eq(0)').text();
        const description = row.find('td:eq(1)').text();
        const longitude = row.find('td:eq(2)').text();
        const latitude = row.find('td:eq(3)').text();
        const weather = row.find('td:eq(4)').text();

        $('#editForm [name="location_id"]').val(id);
        $('#editForm [name="name"]').val(name);
        $('#editForm [name="description"]').val(description);
        $('#editForm [name="longitude"]').val(longitude);
        $('#editForm [name="latitude"]').val(latitude);
        $('#editForm [name="weather"]').val(weather);

        $('#editModal').modal('show');
    });

    $('#saveEdit').on('click', function() {
        const id = $('#editForm [name="location_id"]').val();
        $.ajax({
            url: `/edit-location/${id}/`,
            method: 'POST',
            data: $('#editForm').serialize() + '&csrfmiddlewaretoken=' + $('[name=csrfmiddlewaretoken]').val(),
            success: function(response) {
                if (response.status === 'success') {
                    const location = response.location;
                    const row = $(`tr[data-id="${location.id}"]`);
                    row.find('td:eq(0)').text(location.name);
                    row.find('td:eq(1)').text(location.description);
                    row.find('td:eq(2)').text(location.longitude);
                    row.find('td:eq(3)').text(location.latitude);
                    row.find('td:eq(4)').text(location.weather);
                    $('#editModal').modal('hide');
                }
            }
        });
    });

    // Delete Location
    $(document).on('click', '.delete-btn', function() {
        if (confirm('Are you sure you want to delete this location?')) {
            const row = $(this).closest('tr');
            const id = row.data('id');
            $.ajax({
                url: `/delete-location/${id}/`,
                method: 'POST',
                data: {
                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.status === 'success') {
                        row.remove();
                    }
                }
            });
        }
    });
</script>
{% endblock %}
<!--Daylily Movements-->